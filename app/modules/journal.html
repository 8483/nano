<!DOCTYPE html>
<html>

<head>
    <title>Налог</title>
    <link rel="stylesheet" type="text/css" href="../styles.css" />
    <link rel="stylesheet" type="text/css" href="../lib/flatpickr/flatpickr.css" />
    <link rel="stylesheet" type="text/css" href="../node_modules/@fortawesome/fontawesome-free/css/all.min.css" />

    <script src="../scripts.js"></script>
</head>

<body>
    <div id="app" class="container"></div>
    <script>
        const {
            remote,
            ipcRenderer
        } = require("electron");

        ipcRenderer.on("foo", (e, args) => {
            state.journalId = args;
            update({
                action: "GET_JOURNAL"
            });
        });

        // TODO: Load module local data on startup like accounts, companies. Add a refresh button to reload new data.

        // TODO: Refactor inputs into transaction inputs.
        state = {
            lastJournalId: null,
            journalId: null,
            header: {
                journal_key: "",
                journal_date: ""
            },
            journal: [],
            activeJournalItemId: null,
            focusedElement: "input-journal-item-account-debit",
            inputs: {
                company: "",
                date: "",
                type: "",
                document: "",
                accountDebit: "",
                accountCredit: "",
                amountDebit: "",
                amountCredit: ""
            },
            balance: {
                total_debit: "",
                total_credit: "",
                balance: ""
            }
        };

        function update(msg) {
            switch (msg.action) {

                case "GET_JOURNAL":
                    fetch(`http://localhost:8080/journals/${state.journalId}`)
                        .then(res => res.json())
                        .then(data => {
                            state.header = data.header;
                            state.journal = data.items;
                            state.balance = data.balance;
                            document.title = "Налог - " + data.header.journal_key;
                            view(state);
                            // document
                            //     .getElementById("grid")
                            //     .scrollIntoView(false);
                        })
                        .catch(err => err);
                    break;

                case "SET_JOURNAL_ITEM":
                    // console.log(msg.payload)
                    state.activeJournalItemId = msg.payload.rowId;
                    state.inputs = msg.payload.inputs;
                    view(state);
                    break;

                case "CLEAR_INPUTS_JOURNAL_ITEM":
                    state.activeJournalItemId = null;
                    state.inputs.company = "";
                    state.inputs.date = "";
                    state.inputs.type = "";
                    state.inputs.document = "";
                    state.inputs.accountDebit = "";
                    state.inputs.accountCredit = "";
                    state.inputs.amountDebit = "";
                    state.inputs.amountCredit = "";
                    view(state);
                    break;

                    // Od model treba da gi zima, ne od document
                case "SAVE_JOURNAL_ITEM":
                    fetch("http://localhost:8080/journals", {
                            method: "POST",
                            headers: {
                                Accept: "application/json",
                                "Content-type": "application/json"
                            }, // TODO: Abstract into GET_INPUTS action
                            body: JSON.stringify({
                                journalId: state.journalId,
                                accountDebit: document.getElementById("input-journal-item-account-debit").value,
                                accountCredit: document.getElementById("input-journal-item-account-credit")
                                    .value,
                                amountDebit: document.getElementById("input-journal-item-amount-debit").value,
                                amountCredit: document.getElementById("input-journal-item-amount-credit").value,
                                document: document.getElementById("input-journal-item-document").value,
                                date: document.getElementById("input-journal-item-date").value,
                                company: document.getElementById("input-journal-item-company").value,
                            })
                        })
                        .then(res => res.json()) // Return data.
                        .then(data => {
                            // display error if failed
                            update({
                                action: "GET_JOURNAL",
                                payload: state.journalId
                            });
                        })
                        .catch(err => err);
                    break;

                case "UPDATE_JOURNAL_ITEM":
                    console.log(state.activeJournalItemId)
                    fetch("http://localhost:8080/journals", {
                            method: "PUT",
                            headers: {
                                Accept: "application/json",
                                "Content-type": "application/json"
                            },
                            body: JSON.stringify({
                                journalItemId: state.activeJournalItemId,
                                company: document.getElementById("input-journal-company").value,
                                date: document.getElementById("input-journal-date").value,
                                document: document.getElementById("input-journal-document").value,
                                accountDebit: document.getElementById("input-journal-account-debit").value,
                                accountCredit: document.getElementById("input-journal-account-credit").value,
                                amountDebit: document.getElementById("input-journal-amount-debit").value,
                                amountCredit: document.getElementById("input-journal-amount-credit").value
                            })
                        })
                        .then(res => res.json()) // Return data.
                        .then(data => {
                            // display error if failed
                            update({
                                action: "GET_JOURNAL",
                                payload: state.journalId
                            });
                        })
                        .catch(err => err);
                    break;
            }
            // DEBUG
            // let {
            //     inputs,
            //     journal,
            //     ...debug
            // } = state;
            // console.log(JSON.stringify(debug));
            console.log(state)
            // TODO: DALI SEKOGAS DA IMA VIEW STATE? BI TREBALO.
        }

        function view(state) {
            // TODO: Abstract into component in a UI library

            function header(data) {
                return `
                    <div id="input-header" class="input-header">
                        <button id="button-journal-new" class="btn btn-new"><i class="fas fa-plus"></i></button>
                        <div class="input-group">    
                            <label>Број</label>
                            <input type="text" id="input-journal-key" value="${data.journal_key}">
                        </div>
                        <div class="input-group">
                            <label>Датум</label>
                            <input id="input-journal-date" required value="${data.journal_date}">
                        </div>
                        <button id="button-journal-save" class="btn btn-save"><i class="fas fa-check"></i></button>
                        <button class="btn btn-delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }

            function journal(data) {
                let rows = "";
                for (let i = 0; i < data.length; i++) {
                    rows +=
                        `<tr data-id="${data[i].id}" ${data[i].id == state.activeJournalItemId ? `class="active-row"` : ""}>
                            <td>${data[i].account_debit_id}</td>
                            <td>${data[i].account_credit_id}</td>
                            <td>${data[i].amount_debit}</td>
                            <td>${data[i].amount_credit}</td>
                            <td>${data[i].document_key}</td>
                            <td>${data[i].document_date}</td>
                            <td>${data[i].company_id}</td>
                        </tr>`;
                }

                return `
                    <div id="journal" class="content">
                        <table id="grid" class="grid">
                            <thead>
                                <th>Конто Д</th>
                                <th>Конто П</th>
                                <th>Износ Д</th>
                                <th>Износ П</th>
                                <th>Документ</th>
                                <th>Датум</th>
                                <th>Фирма</th> 
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            }

            function input(data) {
                return `
                    <div id="input-item" class="input-item">
                        <button id="button-journal-item-new" class="btn btn-new"><i class="fas fa-plus"></i></button>
                        <div class="input-group">
                            <label>Конто Должи</label>
                            <input type="text" id="input-journal-item-account-debit" value="${data.accountDebit}">
                        </div>
                        <div class="input-group">
                            <label>Конто Побарува</label>
                            <input type="text" id="input-journal-item-account-credit" value="${data.accountCredit}">
                        </div>
                        <div class="input-group">
                            <label>Износ Должи</label>
                            <input type="text" id="input-journal-item-amount-debit" value="${data.amountDebit}">
                        </div>
                        <div class="input-group">
                            <label>Износ Побарува</label>
                            <input type="text" id="input-journal-item-amount-credit" value="${data.amountCredit}">
                        </div>
                        <div class="input-group">
                            <label>Документ</label>
                            <input type="text" id="input-journal-item-document" value="${data.document}">
                        </div>
                        <div class="input-group">
                            <label>Датум</label>
                            <input id="input-journal-item-date" required value="${data.date}">
                        </div>
                        <div class="input-group">    
                            <label>Фирма</label>
                            <input type="text" id="input-journal-item-company" value="${data.company}">
                        </div>
                        <button id="button-journal-item-save" class="btn btn-save"><i class="fas fa-check"></i></button>
                        <button class="btn btn-delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }

            html =
                `
                ${header(state.header)}
                ${journal(state.journal)}
                ${input(state.inputs)}
                <span style="width: 500px;">
                    <span><b>Должи:</b> ${state.balance.total_debit}</span>
                    <span><b>Побарува:</b> ${state.balance.total_credit}</span>
                    <span><b>Салдо:</b> ${state.balance.balance}</span>
                </span>
            `;

            // console.log(state)

            // Inject i.e. render HTML
            document.getElementById("app").innerHTML = html;

            // Select the first input
            inputFocusAndSelectText(state.focusedElement);

            // Turn input into date input
            makeDateField("input-journal-item-date");

            // Highlight clicked table row. Send a "SET_ITEM" update action.
            document.querySelectorAll(`#journal tr`).forEach(el =>
                el.addEventListener("click", e => {
                    rowClickHandler(e);
                })
            );

            // TODO: How can this be abstracted?
            // Select row and populate inputs.
            function rowClickHandler(e) {
                let inputs = e.target.parentElement.cells;
                let rowId = e.target.parentElement.dataset.id;
                // prevents selecting the header as a row, and populating the inputs
                if (rowId != undefined) {
                    update({
                        action: "SET_JOURNAL_ITEM",
                        payload: {
                            rowId: rowId,
                            inputs: {
                                accountDebit: inputs[0].innerText,
                                accountCredit: inputs[1].innerText,
                                amountDebit: inputs[2].innerText,
                                amountCredit: inputs[3].innerText,
                                document: inputs[4].innerText,
                                date: inputs[5].innerText,
                                company: inputs[6].innerText,

                            }
                        }
                    });
                }
            }

            // Focus active row i.e. prevent table from going to top after clicking on row.
            let activeRow = document.querySelector(
                `[data-id="${state.activeJournalItemId}"]`
            );
            if (activeRow) activeRow.focus();

            // Clear inputs
            document
                .getElementById("button-journal-item-new")
                .addEventListener("click", () => {
                    update({
                        action: "CLEAR_INPUTS_JOURNAL_ITEM"
                    });
                });

            document.addEventListener("keyup", (e) => {
                if (e.key === "Escape") {
                    update({
                        action: "CLEAR_INPUTS_JOURNAL_ITEM"
                    });
                }
            })

            // TODO: How can this be further abstracted with UPDATE?
            // When enter is pressed, jump to field
            onEnterFocus("input-journal-item-account-debit", "input-journal-item-account-credit");
            onEnterFocus("input-journal-item-account-credit", "input-journal-item-amount-debit");
            onEnterFocus("input-journal-item-amount-debit", "input-journal-item-amount-credit");
            onEnterFocus("input-journal-item-amount-credit", "input-journal-item-document");
            onEnterFocus("input-journal-item-document", "input-journal-item-date");
            onEnterFocus("input-journal-item-date", "input-journal-item-company");
            onEnterFocus("input-journal-item-company", "button-journal-item-save");
            onEnterFocus("button-journal-item-save", "input-journal-item-account-debit");

            // Save journal item
            document
                .getElementById("button-journal-item-save")
                .addEventListener("click", () => {
                    saveButtonClickHandler();
                });

            function saveButtonClickHandler() {
                console.log("save clicked");
                if (state.activeJournalItemId === null) {
                    console.log("save");
                    update({
                        action: "SAVE_JOURNAL_ITEM"
                    });
                } else {
                    console.log("update");
                    // TODO: Update action
                    update({
                        action: "UPDATE_JOURNAL_ITEM"
                    });
                }
            }
        }

        // SET ACTIVE JOURNAL ITEM TO NULL ON CHANGE
        ipcRenderer.on("set-journal-active-id", (e, args) => {
            // console.log(args);  // Prints 'foo!'
            update({
                action: "GET_JOURNAL",
                payload: args
            });
        });

        // Initialize
        // update({
        //     action: "GET_LAST_JOURNAL"
        // });
        view(state);
        // Scroll to bottom of table
    </script>
</body>

</html>