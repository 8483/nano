<!DOCTYPE html>
<html>

<head>
    <title>Налог</title>
    <link rel="stylesheet" type="text/css" href="../styles.css" />
    <!-- <link rel="stylesheet" type="text/css" href="../lib/flatpickr/flatpickr.css" /> -->
    <link rel="stylesheet" type="text/css" href="../node_modules/@fortawesome/fontawesome-free/css/all.min.css" />
</head>

<body>
    <div id="app" class="container"></div>
    <script>
        require('../../utils/utils.js')();
        const {
            remote,
            ipcRenderer
        } = require("electron");

        // Everything goes and is taken from state. No direct manipulation.

        // TODO: Load module local data on startup like accounts, companies. Add a refresh button to reload new data.

        // TODO: Refactor inputs into transaction inputs.
        let state = {
            journalId: null,
            header: {
                journal_key: "",
                journal_type_id: "",
                journal_date: ""
            },
            items: [],
            activeJournalItemId: null,
            focusedElement: "input-journal-item-account-debit",
            inputs: {
                account_debit: null,
                account_credit: null,
                amount_debit: null,
                amount_credit: null,
                document_key: null,
                document_date: null,
                company_name: null, // TODO: How can the company_id be stored here, instead in the SAVE action?
            },
            total_debit: 0,
            total_credit: 0,
            balance: 0,
            companies: []
        };

        // Initializing
        // TODO: Make it a promise all that invokes view at end.
        ipcRenderer.on("foo", (e, args) => {
            state.journalId = args;
            update({
                action: "GET_COMPANIES"
            })
            update({
                action: "GET_JOURNAL_HEADER"
            });
            update({
                action: "GET_JOURNAL_ITEMS"
            });
        });

        function update(msg) {
            // console.log("BEFORE update", state)
            switch (msg.action) {
                case "GET_COMPANIES":
                    fetch(`http://localhost:8080/company`)
                        .then(res => res.json())
                        .then(data => {
                            state.companies = data;
                        })
                        .catch(err => err);
                    break;

                case "GET_JOURNAL_HEADER":
                    fetch(`http://localhost:8080/journals/${state.journalId}`)
                        .then(res => res.json())
                        .then(data => {
                            state.header = data;
                            document.title = "Налог - " + data.journal_key;
                            view(state);
                        })
                        .catch(err => err);
                    break;

                case "GET_JOURNAL_ITEMS":
                    fetch(`http://localhost:8080/journals/${state.journalId}/items`)
                        .then(res => res.json())
                        .then(data => {
                            state.items = data;
                            view(state);
                            // document
                            //     .getElementById("grid")
                            //     .scrollIntoView(false);
                        })
                        .catch(err => err);
                    break;

                case "SET_INPUTS_JOURNAL_ITEM":
                    state.activeJournalItemId = msg.payload.rowId;
                    // Doing state.inputs = state.items.filter() creates a weird ass bug that deletes items data??? wtf
                    let temp = state.items.filter(item => item.id == state.activeJournalItemId)[0];
                    // Does this for every property: state.inputs.document_key = temp.document_key;
                    for (let key in state.inputs) { //
                        state.inputs[key] = temp[key];
                    }
                    view(state);
                    break;

                case "GET_INPUTS_JOURNAL_ITEM":
                    state.inputs.account_debit = value("input-journal-item-account-debit");
                    state.inputs.account_credit = value("input-journal-item-account-credit");
                    state.inputs.amount_debit = parseFloat(value("input-journal-item-amount-debit"));
                    state.inputs.amount_credit = parseFloat(value("input-journal-item-amount-credit"));
                    // state.inputs.company_id = parseInt(value("input-journal-item-company"));
                    state.inputs.company_id = parseInt(getDatalistValue('input-journal-item-company', "id"));
                    state.inputs.document_date = value("input-journal-item-date");
                    state.inputs.document_key = value("input-journal-item-document");
                    break;

                case "CLEAR_INPUTS_JOURNAL_ITEM":
                    state.activeJournalItemId = null;
                    // Set all inputs to ""
                    for (let key in state.inputs) { //
                        state.inputs[key] = "";
                    }
                    view(state);
                    break;

                    // TODO: Company field does not repeat
                case "CLEAR_INPUTS_JOURNAL_ITEM_PARTIAL":
                    state.inputs.account_debit = ""
                    state.inputs.amount_debit = ""
                    state.inputs.account_credit = ""
                    state.inputs.amount_credit = ""
                    break;

                    // TODO: Od model kako da gi zima, ne od document
                case "SAVE_JOURNAL_ITEM":
                    update({
                        action: "GET_INPUTS_JOURNAL_ITEM"
                    });
                    if ( // Check for debit/credit combos
                        state.inputs.account_debit != "" && state.inputs.amount_debit != "" ||
                        state.inputs.account_credit != "" && state.inputs.amount_credit != ""
                    ) {
                        fetch(`http://localhost:8080/journals/${state.journalId}/items`, {
                                method: "POST",
                                headers: {
                                    Accept: "application/json",
                                    "Content-type": "application/json"
                                }, // TODO: Abstract into GET_INPUTS action
                                body: JSON.stringify({
                                    accountDebit: state.inputs.account_debit,
                                    accountCredit: state.inputs.account_credit,
                                    amountDebit: state.inputs.amount_debit,
                                    amountCredit: state.inputs.amount_credit,
                                    document: state.inputs.document_key,
                                    date: toDate(state.inputs.document_date),
                                    company: state.inputs.company_id,
                                })
                            })
                            .then(res => res.json()) // Return data.
                            .then(data => {
                                update({
                                    action: "CLEAR_INPUTS_JOURNAL_ITEM_PARTIAL"
                                });

                                update({
                                    action: "GET_JOURNAL_ITEMS"
                                });
                            })
                            .catch(err => err);
                    } else {
                        alert("required fields")
                    }
                    break;

                case "UPDATE_JOURNAL_ITEM":
                    update({
                        action: "GET_INPUTS_JOURNAL_ITEM"
                    });
                    fetch(`http://localhost:8080/journals/${state.journalId}/items/${state.activeJournalItemId}`, {
                            method: "PUT",
                            headers: {
                                Accept: "application/json",
                                "Content-type": "application/json"
                            },
                            body: JSON.stringify({
                                accountDebit: state.inputs.account_debit,
                                accountCredit: state.inputs.account_credit,
                                amountDebit: state.inputs.amount_debit,
                                amountCredit: state.inputs.amount_credit,
                                document: state.inputs.document_key,
                                date: toDate(state.inputs.document_date),
                                company: state.inputs.company_id,
                            })
                        })
                        .then(res => res.json()) // Return data.
                        .then(data => {
                            // display error if failed
                            update({
                                action: "GET_JOURNAL_ITEMS"
                            });
                            update({
                                action: "CLEAR_INPUTS_JOURNAL_ITEM"
                            });
                        })
                        .catch(err => err);
                    break;

                case "DELETE_JOURNAL_ITEM":
                    fetch(`http://localhost:8080/journals/${state.journalId}/items/${state.activeJournalItemId}`, {
                            method: "DELETE",
                            headers: {
                                Accept: "application/json",
                                "Content-type": "application/json"
                            }
                        })
                        .then(res => res.json()) // Return data.
                        .then(data => {
                            // display error if failed
                            update({
                                action: "GET_JOURNAL_ITEMS"
                            });
                            update({
                                action: "CLEAR_INPUTS_JOURNAL_ITEM"
                            });
                        })
                        .catch(err => err);
                    break;
            }
            // DEBUG
            // let {
            //     inputs,
            //     journal,
            //     ...debug
            // } = state;
            // console.log(JSON.stringify(debug));
            console.log("AFTER update", state)
            // TODO: DALI SEKOGAS DA IMA VIEW STATE? BI TREBALO.
        }

        function view(state) {
            // TODO: Abstract into component in a UI library

            function header(data) {
                return `
                    <div id="input-header" class="input-header">
                        <button id="button-journal-new" class="btn btn-new"><i class="fas fa-plus"></i></button>
                        <div class="input-group">    
                            <label>Број</label>
                            <input type="text" id="input-journal-key" value="${data.journal_key}">
                        </div>
                        <div class="input-group">
                            <label>Датум</label>
                            <input id="input-journal-date" required value="${data.journal_date}">
                        </div>
                        <div class="input-group">
                            <label>Вид</label>
                            <input id="input-journal-type" list="journal-type" multiple value="${data.journal_type_id}">
                            <datalist id="journal-type">
                                <option value="Вид 1">
                                <option value="Вид 2">
                                <option value="Вид 3">
                            </datalist>
                        </div>
                        <button id="button-journal-save" class="btn btn-save"><i class="fas fa-check"></i></button>
                        <button class="btn btn-delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }

            function items(data) {
                let rows = "";
                for (let i = 0; i < data.length; i++) {
                    rows +=
                        `<tr data-id="${data[i].id}" ${data[i].id == state.activeJournalItemId ? `class="active-row"` : ""}>
                            <td>${nullToEmpty(data[i].account_debit)}</td>
                            <td>${nullToEmpty(data[i].account_credit)}</td>
                            <td>${nullToEmpty(data[i].amount_debit)}</td>
                            <td>${nullToEmpty(data[i].amount_credit)}</td>
                            <td>${nullToEmpty(data[i].document_key)}</td>
                            <td>${nullToEmpty(data[i].document_date)}</td>
                            <td>${nullToEmpty(data[i].company_name)}</td>
                            <td>${nullToEmpty(data[i].company_id)}</td>
                        </tr>`;
                }

                return `
                    <div id="journal" class="content">
                        <table id="grid" class="grid">
                            <thead>
                                <th>Конто Д</th>
                                <th>Конто П</th>
                                <th>Износ Д</th>
                                <th>Износ П</th>
                                <th>Документ</th>
                                <th>Датум</th>
                                <th>Фирма</th> 
                                <th>Фирма ID</th> 
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            }

            function companies() {
                let html = "";
                state.companies.map(company => {
                    html +=
                        `<option 
                            data-id="${company.id}" 
                            data-key="${company.company_key}"
                            data-id="${company.name}"
                            value="${company.name}"
                        >
                            ${company.name}
                        </option>`
                })
                return html;
            }

            function input(data) {
                return `
                    <div id="input-item" class="input-item">
                        <button id="button-journal-item-new" class="btn btn-new"><i class="fas fa-plus"></i></button>
                        <div class="input-group">
                            <label>Конто Должи</label>
                            <input type="text" id="input-journal-item-account-debit" value="${nullToEmpty(data.account_debit)}">
                        </div>
                        <div class="input-group">
                            <label>Конто Побарува</label>
                            <input type="text" id="input-journal-item-account-credit" value="${nullToEmpty(data.account_credit)}">
                        </div>
                        <div class="input-group">
                            <label>Износ Должи</label>
                            <input type="text" id="input-journal-item-amount-debit" value="${nullToEmpty(data.amount_debit)}">
                        </div>
                        <div class="input-group">
                            <label>Износ Побарува</label>
                            <input type="text" id="input-journal-item-amount-credit" value="${nullToEmpty(data.amount_credit)}">
                        </div>
                        <div class="input-group">
                            <label>Документ</label>
                            <input type="text" id="input-journal-item-document" value="${nullToEmpty(data.document_key)}">
                        </div>
                        <div class="input-group">
                            <label>Датум</label>
                            <input id="input-journal-item-date" required value="${nullToEmpty(data.document_date)}">
                        </div>
                        <div class="input-group">    
                            <label>Фирма</label>
                            <input type="text" id="input-journal-item-company" list="input-companies" value="${nullToEmpty(data.company_name)}">
                            <datalist id="input-companies">
                                ${companies()}
                            </datalist>
                        </div>
                        <button id="button-journal-item-save" class="btn btn-save"><i class="fas fa-check"></i></button>
                        <button id="button-journal-item-delete" class="btn btn-delete"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            }

            function balance(data) {
                state.total_debit = 0;
                state.total_credit = 0;
                state.balance = 0;

                data.map(item => {
                    state.total_debit += item.amount_debit;
                    state.total_credit += item.amount_credit;
                    // console.log(state.balance)
                })

                state.balance = state.total_debit - state.total_credit;

                return `
                    <span style="width: 500px;">
                        <span><b>Должи:</b> ${state.total_debit}</span>
                        <span><b>Побарува:</b> ${state.total_credit}</span>
                        <span><b>Салдо:</b> <span style="${state.balance != 0 ? "color: red" : ""}">${state.balance}</span></span>
                    </span>
                `
            }

            html =
                `
                ${header(state.header)}
                ${items(state.items)}
                ${input(state.inputs)}
                ${balance(state.items)}
            `;

            // Inject i.e. render HTML
            document.getElementById("app").innerHTML = html;

            // Select the first input
            inputFocusAndSelectText(state.focusedElement);

            // Turn input into date input
            makeDateField("input-journal-item-date");

            // Highlight clicked table row. Send a "SET_ITEM" update action.
            document.querySelectorAll(`#journal tr`).forEach(el =>
                el.addEventListener("click", e => {
                    rowClickHandler(e);
                })
            );

            // TODO: How can this be abstracted?
            // Select row and populate inputs from state.
            function rowClickHandler(e) {
                let rowId = e.target.parentElement.dataset.id;
                // prevents selecting the header as a row, and populating the inputs
                if (rowId != undefined) {
                    update({
                        action: "SET_INPUTS_JOURNAL_ITEM",
                        payload: {
                            rowId: rowId,
                        }
                    });
                }
            }

            // Focus active row i.e. prevent table from going to top after clicking on row.
            let activeRow = document.querySelector(
                `[data-id="${state.activeJournalItemId}"]`
            );
            if (activeRow) activeRow.focus();

            // Clear inputs
            document
                .getElementById("button-journal-item-new")
                .addEventListener("click", () => {
                    update({
                        action: "CLEAR_INPUTS_JOURNAL_ITEM"
                    });
                });

            // TODO: How can this be further abstracted with UPDATE?
            // When enter is pressed, jump to field
            onEnterFocus("input-journal-item-account-debit", "input-journal-item-account-credit");
            onEnterFocus("input-journal-item-account-credit", "input-journal-item-amount-debit");
            onEnterFocus("input-journal-item-amount-debit", "input-journal-item-amount-credit");
            onEnterFocus("input-journal-item-amount-credit", "input-journal-item-document");
            onEnterFocus("input-journal-item-document", "input-journal-item-date");
            onEnterFocus("input-journal-item-date", "input-journal-item-company");
            onEnterFocus("input-journal-item-company", "button-journal-item-save");
            onEnterFocus("button-journal-item-save", "input-journal-item-account-debit");

            // Save journal item
            document
                .getElementById("button-journal-item-save")
                .addEventListener("click", () => {
                    if (state.activeJournalItemId === null) {
                        update({
                            action: "SAVE_JOURNAL_ITEM"
                        });
                    } else {
                        console.log("update");
                        // TODO: Update action
                        update({
                            action: "UPDATE_JOURNAL_ITEM"
                        });
                    }
                });

            // Delete journal item
            document
                .getElementById("button-journal-item-delete")
                .addEventListener("click", () => {
                    update({
                        action: "DELETE_JOURNAL_ITEM"
                    });
                });
        }

        view(state);
        // Scroll to bottom of table

        // This needs to be outside because it stacks with each view call, because it's a window event
        document
            .addEventListener("keyup", (e) => {
                if (e.key === "Escape") {
                    update({
                        action: "CLEAR_INPUTS_JOURNAL_ITEM"
                    });
                }
            })
    </script>
</body>

</html>